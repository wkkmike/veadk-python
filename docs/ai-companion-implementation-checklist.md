# AI陪聊系统 - 实施清单

## 确认的技术选型

| 模块 | 选择 | 状态 |
|------|------|------|
| 短期记忆 | ✅ **方案A：纯Redis** | 已确认 |
| 长期记忆 | VikingDB + MySQL + TOS | 待实施 |
| 大模型 | doubao-seed-character (主) + doubao-pro/lite (备) | 待实施 |
| 开发语言 | Python | 已确认 |
| 部署平台 | 火山云 VKE | 待实施 |

---

## Phase 1: MVP 开发清单 (第1-4周)

### Week 1: 基础设施搭建

#### 火山云资源创建
- [ ] 创建 VPC 网络
- [ ] 创建 VKE Kubernetes 集群 (3节点 8C16G)
- [ ] 创建云数据库 Redis (4GB 主从版)
- [ ] 创建云数据库 MySQL (4C8G)
- [ ] 配置安全组规则
- [ ] 申请 CLB 负载均衡
- [ ] 开通火山方舟 API

#### 开发环境搭建
- [ ] 初始化 Python 项目
- [ ] 配置 pyproject.toml / requirements.txt
- [ ] 配置 pre-commit hooks
- [ ] 搭建本地 Redis/MySQL (Docker Compose)
- [ ] 配置 CI/CD 流水线

### Week 2: 核心服务开发

#### 短期记忆模块 (方案A)
- [ ] 实现 Redis 客户端连接池
- [ ] 实现 Message 数据模型
- [ ] 实现 ShortMemoryManager
- [ ] 实现超时降级逻辑
- [ ] 编写单元测试
- [ ] 编写集成测试

#### 大模型服务
- [ ] 实现火山方舟 API 客户端
- [ ] 实现流式响应处理
- [ ] 实现熔断器 (CircuitBreaker)
- [ ] 实现模型降级链
- [ ] 编写测试用例

### Week 3: 业务功能开发

#### 对话服务
- [ ] 实现 ChatService
- [ ] 实现上下文组装逻辑
- [ ] 实现 Token 计算与裁剪
- [ ] 实现 SSE 流式响应
- [ ] 集成短期记忆

#### 角色服务
- [ ] 设计角色数据模型
- [ ] 实现角色 CRUD API
- [ ] 实现角色配置缓存
- [ ] 实现默认角色（降级用）

#### API 网关
- [ ] 实现 JWT 认证
- [ ] 实现请求限流
- [ ] 实现路由配置
- [ ] 配置 CORS

### Week 4: 测试与部署

#### 测试
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试
- [ ] 性能测试 (目标: P99 < 10s)
- [ ] 故障注入测试

#### 部署
- [ ] 编写 Dockerfile
- [ ] 编写 Kubernetes 部署文件
- [ ] 配置 HPA 自动扩缩容
- [ ] 配置健康检查
- [ ] 灰度发布验证

---

## Phase 2: 长期记忆实现 (第5-8周)

### Week 5-6: 长期记忆核心

#### VikingDB 集成
- [ ] 创建 VikingDB Collection
- [ ] 实现 Embedding 调用
- [ ] 实现向量检索
- [ ] 实现标量过滤

#### 记忆生成 Worker
- [ ] 设计 Kafka Topic
- [ ] 实现对话摘要生成 (LLM)
- [ ] 实现用户画像提取 (LLM)
- [ ] 实现关键事件识别 (LLM)
- [ ] 实现向量化存储

### Week 7: 记忆召回

#### 意图识别
- [ ] 实现召回意图判断
- [ ] 实现召回关键词提取
- [ ] 实现规则 + LLM 混合判断

#### 记忆检索与融合
- [ ] 实现 VikingDB 向量检索
- [ ] 实现 MySQL 结构化查询
- [ ] 实现结果融合与排序
- [ ] 实现上下文注入

### Week 8: 高可用增强

- [ ] 长期记忆检索降级
- [ ] VikingDB 超时处理
- [ ] MySQL 读写分离
- [ ] 完善监控告警

---

## Phase 3: 生产优化 (第9-12周)

### 性能优化
- [ ] Redis 连接池调优
- [ ] 数据库查询优化
- [ ] 异步任务优化
- [ ] 缓存预热策略

### 可扩展性
- [ ] HPA 参数调优
- [ ] Redis Cluster 评估
- [ ] MySQL 分库分表预研

### 可观测性
- [ ] APMPlus 全链路追踪
- [ ] 自定义 Dashboard
- [ ] 告警规则完善
- [ ] 日志聚合配置

### 安全加固
- [ ] API 安全扫描
- [ ] 敏感数据加密
- [ ] 访问控制审计

---

## 关键里程碑

| 里程碑 | 目标日期 | 交付物 |
|--------|---------|--------|
| M1: MVP可用 | Week 4 | 基础对话功能 + 短期记忆 |
| M2: 记忆完整 | Week 8 | 长期记忆 + 高可用 |
| M3: 生产就绪 | Week 12 | 性能优化 + 安全加固 |

---

## 风险与应对

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| 模型响应慢 | 高 | 高 | 降级链 + 超时控制 |
| Redis 故障 | 低 | 中 | 主从 + 哨兵 + 降级 |
| 流量突增 | 中 | 高 | HPA + 限流 |
| VikingDB 不熟悉 | 中 | 中 | 提前POC + 降级策略 |

---

## 下一步行动

1. **立即开始**: 创建火山云资源 (VKE, Redis, MySQL)
2. **本周完成**: 初始化项目，实现短期记忆模块
3. **需要决策**: 
   - 角色管理的详细需求
   - 长期记忆的具体存储字段
   - 监控告警的接收方式
