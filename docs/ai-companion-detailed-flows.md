# AI陪聊系统 - 详细流程设计

## 1. 核心对话流程时序图

```
┌──────┐    ┌──────┐    ┌────────┐    ┌───────┐    ┌───────┐    ┌────────┐    ┌─────────┐
│Client│    │Gateway│    │ChatSvc │    │MemSvc │    │ Redis │    │VikingDB│    │火山方舟  │
└──┬───┘    └──┬───┘    └───┬────┘    └───┬───┘    └───┬───┘    └───┬────┘    └────┬────┘
   │           │            │             │            │            │              │
   │ POST /chat/stream      │             │            │            │              │
   │──────────────────────▶│             │            │            │              │
   │           │            │             │            │            │              │
   │           │ JWT验证+限流│             │            │            │              │
   │           │───────────▶│             │            │            │              │
   │           │            │             │            │            │              │
   │           │            │ 获取短期记忆 │            │            │              │
   │           │            │────────────▶│            │            │              │
   │           │            │             │ LRANGE     │            │              │
   │           │            │             │───────────▶│            │              │
   │           │            │             │◀───────────│            │              │
   │           │            │◀────────────│            │            │              │
   │           │            │             │            │            │              │
   │           │            │ 意图识别(是否需要长期记忆) │            │              │
   │           │            │─────────────────────────────────────────────────────▶│
   │           │            │◀─────────────────────────────────────────────────────│
   │           │            │             │            │            │              │
   │           │            │ [如需要] 召回长期记忆     │            │              │
   │           │            │────────────▶│            │            │              │
   │           │            │             │            │ 向量检索   │              │
   │           │            │             │────────────────────────▶│              │
   │           │            │             │◀────────────────────────│              │
   │           │            │◀────────────│            │            │              │
   │           │            │             │            │            │              │
   │           │            │ 组装Context + 流式调用LLM │            │              │
   │           │            │─────────────────────────────────────────────────────▶│
   │           │            │             │            │            │              │
   │ SSE: chunk1            │◀─────────────────────────────────────────────────────│
   │◀──────────────────────────────────────            │            │              │
   │ SSE: chunk2            │◀─────────────────────────────────────────────────────│
   │◀──────────────────────────────────────            │            │              │
   │ SSE: ...               │             │            │            │              │
   │◀──────────────────────────────────────            │            │              │
   │ SSE: done              │             │            │            │              │
   │◀──────────────────────────────────────            │            │              │
   │           │            │             │            │            │              │
   │           │            │ [异步] 保存消息到短期记忆 │            │              │
   │           │            │────────────▶│            │            │              │
   │           │            │             │ LPUSH+LTRIM│            │              │
   │           │            │             │───────────▶│            │              │
   │           │            │             │            │            │              │
   │           │            │ [异步] 发送到Kafka处理长期记忆         │              │
   │           │            │────────────────────────▶│             │              │
   └───────────┴────────────┴─────────────┴────────────┴────────────┴──────────────┘
```

## 2. 长期记忆生成流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              长期记忆生成流程 (异步)                                  │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                对话结束/累积阈值触发
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   Kafka Topic                                        │
│                              memory_generation_tasks                                 │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Memory Worker (消费者组)                                │
│                                                                                      │
│   ┌────────────────────────────────────────────────────────────────────────────┐    │
│   │  Step 1: 加载原始对话                                                       │    │
│   │                                                                              │    │
│   │  从 Redis 获取待处理的对话消息列表                                           │    │
│   │  messages = redis.lrange(f"chat:{user_id}:{char_id}:messages", 0, -1)       │    │
│   └────────────────────────────────────────────────────────────────────────────┘    │
│                                         │                                           │
│                                         ▼                                           │
│   ┌────────────────────────────────────────────────────────────────────────────┐    │
│   │  Step 2: LLM 生成对话摘要                                                   │    │
│   │                                                                              │    │
│   │  Prompt:                                                                     │    │
│   │  """                                                                         │    │
│   │  请总结以下对话的主要内容，包括：                                             │    │
│   │  1. 讨论的主要话题（用标签表示）                                              │    │
│   │  2. 对话的情感基调                                                           │    │
│   │  3. 100字以内的摘要                                                          │    │
│   │                                                                              │    │
│   │  对话内容：                                                                   │    │
│   │  {conversation}                                                              │    │
│   │                                                                              │    │
│   │  输出JSON格式：                                                               │    │
│   │  {                                                                           │    │
│   │    "topics": ["话题1", "话题2"],                                             │    │
│   │    "emotion": "positive/neutral/negative",                                   │    │
│   │    "summary": "摘要内容"                                                     │    │
│   │  }                                                                           │    │
│   │  """                                                                         │    │
│   └────────────────────────────────────────────────────────────────────────────┘    │
│                                         │                                           │
│                                         ▼                                           │
│   ┌────────────────────────────────────────────────────────────────────────────┐    │
│   │  Step 3: LLM 提取用户画像                                                   │    │
│   │                                                                              │    │
│   │  Prompt:                                                                     │    │
│   │  """                                                                         │    │
│   │  从以下对话中提取用户透露的个人信息，注意：                                    │    │
│   │  - 只提取用户明确说出的信息                                                   │    │
│   │  - 给每条信息一个置信度(0-1)                                                  │    │
│   │                                                                              │    │
│   │  可提取的信息类型：                                                           │    │
│   │  - basic_info: 姓名、年龄、生日、职业、居住地等                               │    │
│   │  - preference: 喜好、厌恶、习惯等                                            │    │
│   │  - relationship: 与AI角色的关系定位                                          │    │
│   │                                                                              │    │
│   │  对话内容：                                                                   │    │
│   │  {conversation}                                                              │    │
│   │                                                                              │    │
│   │  输出JSON格式：                                                               │    │
│   │  {                                                                           │    │
│   │    "profiles": [                                                             │    │
│   │      {"type": "basic_info", "key": "name", "value": "小明", "confidence": 1.0},│   │
│   │      {"type": "preference", "key": "favorite_food", "value": "火锅", ...}     │   │
│   │    ]                                                                         │    │
│   │  }                                                                           │    │
│   │  """                                                                         │    │
│   └────────────────────────────────────────────────────────────────────────────┘    │
│                                         │                                           │
│                                         ▼                                           │
│   ┌────────────────────────────────────────────────────────────────────────────┐    │
│   │  Step 4: LLM 识别关键事件                                                   │    │
│   │                                                                              │    │
│   │  Prompt:                                                                     │    │
│   │  """                                                                         │    │
│   │  从以下对话中识别用户提到的重要事件，包括：                                    │    │
│   │  - 生日、纪念日                                                              │    │
│   │  - 重要的人生事件（毕业、入职、结婚等）                                       │    │
│   │  - 情感事件（开心的事、难过的事）                                            │    │
│   │                                                                              │    │
│   │  对话内容：                                                                   │    │
│   │  {conversation}                                                              │    │
│   │                                                                              │    │
│   │  输出JSON格式：                                                               │    │
│   │  {                                                                           │    │
│   │    "events": [                                                               │    │
│   │      {                                                                       │    │
│   │        "type": "birthday",                                                   │    │
│   │        "summary": "用户说自己生日是3月15日",                                  │    │
│   │        "date": "03-15",                                                      │    │
│   │        "emotion": "neutral",                                                 │    │
│   │        "importance": 8                                                       │    │
│   │      }                                                                       │    │
│   │    ]                                                                         │    │
│   │  }                                                                           │    │
│   │  """                                                                         │    │
│   └────────────────────────────────────────────────────────────────────────────┘    │
│                                         │                                           │
│                                         ▼                                           │
│   ┌────────────────────────────────────────────────────────────────────────────┐    │
│   │  Step 5: 向量化 & 存储                                                      │    │
│   │                                                                              │    │
│   │  5.1 调用 Embedding API 生成向量                                            │    │
│   │      vector = embedding_api.embed(summary_text)                             │    │
│   │                                                                              │    │
│   │  5.2 存储到 VikingDB                                                        │    │
│   │      vikingdb.insert({                                                       │    │
│   │          "vector": vector,                                                   │    │
│   │          "user_id": user_id,                                                 │    │
│   │          "character_id": char_id,                                            │    │
│   │          "memory_type": "summary",                                           │    │
│   │          "content": summary_text,                                            │    │
│   │          "timestamp": timestamp                                              │    │
│   │      })                                                                      │    │
│   │                                                                              │    │
│   │  5.3 更新 MySQL 索引 (用户画像、事件表)                                       │    │
│   │      UPSERT user_profiles ...                                               │    │
│   │      INSERT user_events ...                                                 │    │
│   │                                                                              │    │
│   │  5.4 归档原始对话到 TOS                                                      │    │
│   │      tos.put_object(                                                         │    │
│   │          bucket="conversation-archive",                                      │    │
│   │          key=f"{user_id}/{char_id}/{date}.json",                            │    │
│   │          body=conversation_json                                              │    │
│   │      )                                                                       │    │
│   └────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 3. 长期记忆召回详细流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              长期记忆召回详细流程                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

用户消息: "我上次跟你说的那个事情，你还记得吗？"
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  Step 1: 快速意图识别 (使用轻量级模型或规则)                                         │
│                                                                                      │
│  输入:                                                                               │
│  - 用户当前消息                                                                      │
│  - 最近3轮对话摘要                                                                   │
│                                                                                      │
│  识别关键词/模式:                                                                    │
│  - "上次"、"之前"、"以前"、"还记得" → 需要召回 history                               │
│  - "我叫"、"我的名字"、"我喜欢" → 需要召回 profile                                   │
│  - "那件事"、"那天" → 需要召回 event                                                 │
│                                                                                      │
│  输出:                                                                               │
│  {                                                                                   │
│    "need_recall": true,                                                              │
│    "recall_types": ["history", "event"],                                            │
│    "search_query": "上次说的事情",                                                   │
│    "time_hint": "recent"  // recent/specific_date/any                               │
│  }                                                                                   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  Step 2: 并行检索 (设置总超时 2s)                                                    │
│                                                                                      │
│  ┌─────────────────────────────────┐  ┌─────────────────────────────────┐           │
│  │  VikingDB 向量检索               │  │  MySQL 结构化查询               │           │
│  │                                 │  │                                 │           │
│  │  query_vector = embed(          │  │  -- 查询用户画像                 │           │
│  │    "上次说的事情"               │  │  SELECT * FROM user_profiles    │           │
│  │  )                              │  │  WHERE user_id = ?              │           │
│  │                                 │  │  AND character_id = ?           │           │
│  │  results = vikingdb.search(     │  │                                 │           │
│  │    collection="long_term_memory",│  │  -- 查询相关事件                 │           │
│  │    vector=query_vector,         │  │  SELECT * FROM user_events      │           │
│  │    filter={                     │  │  WHERE user_id = ?              │           │
│  │      "user_id": user_id,        │  │  AND character_id = ?           │           │
│  │      "character_id": char_id    │  │  ORDER BY created_at DESC       │           │
│  │    },                           │  │  LIMIT 10                       │           │
│  │    top_k=5                      │  │                                 │           │
│  │  )                              │  │                                 │           │
│  └─────────────────────────────────┘  └─────────────────────────────────┘           │
│                                         │                                           │
│                      ┌──────────────────┴──────────────────┐                        │
│                      ▼                                     ▼                        │
│              向量检索结果                            结构化查询结果                  │
│              (相似度排序)                            (时间排序)                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  Step 3: 结果融合与排序                                                              │
│                                                                                      │
│  融合算法:                                                                           │
│  final_score = α × similarity_score + β × recency_score + γ × importance_score      │
│                                                                                      │
│  其中:                                                                               │
│  - similarity_score: 向量相似度 (0-1)                                               │
│  - recency_score: 时间衰减 exp(-λ × days_ago)                                       │
│  - importance_score: 重要性评分 (0-1)                                               │
│  - α=0.5, β=0.3, γ=0.2 (可调参数)                                                   │
│                                                                                      │
│  去重 & 截断:                                                                        │
│  - 相似内容去重                                                                      │
│  - 保留 Top 3-5 条记忆                                                              │
│  - 控制总token数 < 1000                                                             │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  Step 4: 格式化注入上下文                                                            │
│                                                                                      │
│  System Prompt 模板:                                                                 │
│  """                                                                                 │
│  {角色人设}                                                                          │
│                                                                                      │
│  ## 关于用户的记忆                                                                   │
│  你记得关于{用户称呼}的以下信息：                                                    │
│                                                                                      │
│  ### 用户基本信息                                                                    │
│  - 名字: {name}                                                                      │
│  - 生日: {birthday}                                                                  │
│  - 喜好: {preferences}                                                               │
│                                                                                      │
│  ### 相关历史对话                                                                    │
│  {formatted_memories}                                                                │
│                                                                                      │
│  请基于这些记忆自然地回应用户，不要生硬地提及"我的记忆显示..."                        │
│  """                                                                                 │
│                                                                                      │
│  formatted_memories 示例:                                                            │
│  """                                                                                 │
│  - [3天前] 你们聊到了工作压力的问题，用户提到最近项目很忙                              │
│  - [1周前] 用户分享了周末去爬山的经历，心情很好                                       │
│  """                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 4. 降级流程详图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              降级决策树                                              │
└─────────────────────────────────────────────────────────────────────────────────────┘

                              用户请求到达
                                   │
                                   ▼
                    ┌─────────────────────────────┐
                    │     API Gateway 限流检查     │
                    └─────────────┬───────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                 通过                         触发限流
                    │                           │
                    ▼                           ▼
            正常处理流程                 返回 429 + 排队提示
                    │
                    ▼
        ┌─────────────────────────────┐
        │     获取短期记忆 (Redis)     │
        └─────────────┬───────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
     成功                         失败/超时
        │                           │
        ▼                           ▼
   使用历史上下文           ┌──────────────────┐
        │                  │  降级: 无历史上下文 │
        │                  │  继续处理         │
        │                  └────────┬─────────┘
        │                           │
        └───────────┬───────────────┘
                    │
                    ▼
        ┌─────────────────────────────┐
        │     意图识别 (需要长期记忆?)  │
        └─────────────┬───────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
     需要                        不需要
        │                           │
        ▼                           │
┌───────────────────────┐           │
│ 检索长期记忆 (并行)    │           │
└───────────┬───────────┘           │
            │                       │
┌───────────┴───────────┐           │
│                       │           │
│  VikingDB  │  MySQL   │           │
│    检索    │   查询   │           │
└─────┬─────┴────┬─────┘           │
      │          │                  │
   成功/部分成功  全部失败            │
      │          │                  │
      ▼          ▼                  │
  融合结果    ┌──────────────────┐   │
      │      │ 降级: 跳过长期记忆 │   │
      │      │ 只用短期上下文    │   │
      │      └────────┬─────────┘   │
      │               │             │
      └───────┬───────┴─────────────┘
              │
              ▼
      ┌─────────────────────────────┐
      │       组装完整 Context       │
      └─────────────┬───────────────┘
                    │
                    ▼
      ┌─────────────────────────────┐
      │   调用主模型 (doubao-seed)   │
      └─────────────┬───────────────┘
                    │
      ┌─────────────┴─────────────┐
      │                           │
   成功                     失败/熔断触发
      │                           │
      ▼                           ▼
  返回流式响应         ┌─────────────────────────┐
                      │ 尝试备用模型 (doubao-pro) │
                      └───────────┬─────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                 成功                         失败
                    │                           │
                    ▼                           ▼
              返回流式响应         ┌─────────────────────────┐
                                  │ 尝试兜底模型 (doubao-lite)│
                                  └───────────┬─────────────┘
                                              │
                                ┌─────────────┴─────────────┐
                                │                           │
                             成功                         失败
                                │                           │
                                ▼                           ▼
                          返回流式响应              返回兜底话术
                                                  "抱歉，我现在有点忙..."
```

## 5. 会话状态管理

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              会话状态机                                              │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                 ┌─────────────┐
                                 │   IDLE      │
                                 │  (空闲)     │
                                 └──────┬──────┘
                                        │
                                 用户发送消息
                                        │
                                        ▼
                                 ┌─────────────┐
                    ┌───────────▶│   ACTIVE    │◀───────────┐
                    │            │  (活跃对话)  │            │
                    │            └──────┬──────┘            │
                    │                   │                   │
                    │         ┌─────────┴─────────┐        │
                    │         │                   │        │
                    │    用户继续发送         无消息超时     │
                    │    消息                (5分钟)       │
                    │         │                   │        │
                    │         │                   ▼        │
                    │         │          ┌─────────────┐   │
                    └─────────┘          │  INACTIVE   │   │
                                         │  (不活跃)   │   │
                                         └──────┬──────┘   │
                                                │         │
                                      ┌─────────┴─────────┤
                                      │                   │
                              继续超时(30分钟)        用户回来
                                      │                   │
                                      ▼                   │
                               ┌─────────────┐            │
                               │   ENDED     │────────────┘
                               │  (会话结束)  │   (开启新会话)
                               └──────┬──────┘
                                      │
                                      │ 触发长期记忆生成
                                      ▼
                               ┌─────────────┐
                               │  ARCHIVED   │
                               │  (已归档)   │
                               └─────────────┘

状态存储 (Redis Hash):
┌────────────────────────────────────────────────────────────────────────────────────┐
│  Key: session:{user_id}:{character_id}                                             │
│                                                                                     │
│  Fields:                                                                            │
│  - state: "ACTIVE" | "INACTIVE" | "ENDED"                                          │
│  - last_active_at: 1699999999                                                      │
│  - message_count: 25                                                               │
│  - session_start: 1699998888                                                       │
│  - topic_summary: "讨论工作压力"                                                   │
│                                                                                     │
│  TTL: 86400s (24小时)                                                              │
└────────────────────────────────────────────────────────────────────────────────────┘
```

## 6. 消息处理流水线

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              消息处理流水线                                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

用户消息
    │
    ▼
┌─────────────────┐
│  1. 消息预处理   │
│                 │
│  - 长度校验     │
│  - 编码处理     │
│  - XSS过滤      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  2. 会话路由    │
│                 │
│  - 获取角色配置  │
│  - 加载系统提示  │
│  - 确定模型参数  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  3. 上下文组装   │
│                 │
│  - 短期记忆     │
│  - 长期记忆(可选)│
│  - Token计算    │
│  - 上下文裁剪   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  4. 模型调用    │
│                 │
│  - 负载均衡     │
│  - 熔断检测     │
│  - 流式调用     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  5. 响应处理    │
│                 │
│  - 流式输出     │
│  - 内容拼接     │
│  - 异常处理     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  6. 后处理(异步) │
│                 │
│  - 保存消息     │
│  - 更新会话状态  │
│  - 触发记忆任务  │
└─────────────────┘
```

## 7. Token 预算管理

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Token 预算分配                                          │
│                                                                                      │
│  总预算: 32,000 tokens (doubao-seed-character 上下文窗口)                           │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                              │    │
│  │  ┌─────────────────┐  约 2,000 tokens                                       │    │
│  │  │  系统提示词      │  角色人设 + 行为指南                                    │    │
│  │  └─────────────────┘                                                         │    │
│  │                                                                              │    │
│  │  ┌─────────────────┐  约 1,000 tokens                                       │    │
│  │  │  长期记忆        │  用户画像 + 历史摘要 (召回时使用)                        │    │
│  │  └─────────────────┘                                                         │    │
│  │                                                                              │    │
│  │  ┌─────────────────┐  约 20,000 tokens                                      │    │
│  │  │  短期记忆        │  最近对话历史 (动态裁剪)                                │    │
│  │  └─────────────────┘                                                         │    │
│  │                                                                              │    │
│  │  ┌─────────────────┐  约 500 tokens                                         │    │
│  │  │  当前用户消息    │                                                         │    │
│  │  └─────────────────┘                                                         │    │
│  │                                                                              │    │
│  │  ┌─────────────────┐  约 8,500 tokens                                       │    │
│  │  │  模型回复预留    │  为AI回复留出空间                                       │    │
│  │  └─────────────────┘                                                         │    │
│  │                                                                              │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  裁剪策略:                                                                           │
│  1. 优先保留最近的对话                                                              │
│  2. 保留所有 user 消息，裁剪 assistant 消息                                         │
│  3. 保留对话边界完整性（不截断单条消息中间）                                          │
│  4. 长期记忆只在需要时才注入，不总是占用                                             │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 8. 监控指标定义

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              关键业务指标 (KPI)                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────────────┐
│  可用性指标                                                                        │
├───────────────────────────────────────────────────────────────────────────────────┤
│  指标名                    │ 计算方式                      │ 目标值              │
│  ─────────────────────────┼──────────────────────────────┼────────────────────│
│  chat_success_rate        │ 成功请求数 / 总请求数          │ > 99.9%            │
│  chat_availability        │ 正常响应时间占比               │ > 99.95%           │
│  degraded_rate            │ 降级请求数 / 总请求数          │ < 1%               │
└───────────────────────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────────────┐
│  性能指标                                                                          │
├───────────────────────────────────────────────────────────────────────────────────┤
│  指标名                    │ 计算方式                      │ 目标值              │
│  ─────────────────────────┼──────────────────────────────┼────────────────────│
│  chat_latency_p50         │ 响应时间中位数                 │ < 3s               │
│  chat_latency_p99         │ 响应时间99分位                 │ < 10s              │
│  first_token_latency      │ 首Token延迟                   │ < 1s               │
│  memory_recall_latency    │ 长期记忆召回延迟               │ < 500ms            │
└───────────────────────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────────────┐
│  模型指标                                                                          │
├───────────────────────────────────────────────────────────────────────────────────┤
│  指标名                    │ 计算方式                      │ 目标值              │
│  ─────────────────────────┼──────────────────────────────┼────────────────────│
│  primary_model_success    │ 主模型成功率                   │ > 95%              │
│  model_fallback_rate      │ 降级到备用模型的比率            │ < 5%               │
│  model_circuit_open       │ 熔断器打开次数                 │ 越少越好            │
│  tokens_per_request       │ 每请求平均token消耗            │ 监控趋势            │
└───────────────────────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────────────┐
│  记忆系统指标                                                                      │
├───────────────────────────────────────────────────────────────────────────────────┤
│  指标名                    │ 计算方式                      │ 目标值              │
│  ─────────────────────────┼──────────────────────────────┼────────────────────│
│  short_memory_hit_rate    │ Redis缓存命中率                │ > 99%              │
│  long_memory_recall_rate  │ 长期记忆被召回的比率            │ 监控趋势            │
│  memory_generation_lag    │ 记忆生成延迟                   │ < 5min             │
│  vikingdb_search_latency  │ 向量检索延迟                   │ < 200ms            │
└───────────────────────────────────────────────────────────────────────────────────┘
```
